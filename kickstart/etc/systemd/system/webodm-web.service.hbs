[Unit]
Description=WebODM - web
After=docker.service redis.service nodeodm.service
Requires=docker.service redis.service nodeodm.service

[Service]
Restart=always
ExecStartPre=-/usr/bin/docker kill %n
ExecStartPre=-/usr/bin/docker rm %n
ExecStart=/bin/bash -c "docker run \
    --init \
    --rm \
    -e WO_PORT=11111 \
    -e WO_HOST=$(jq -r .posm_fqdn /etc/posm.json) \
    -e WO_BROKER=redis://redis \
    -e WO_PGHOST=$(hostname -I | awk '{print $1}') \
    -p 11111:8000 \
    --link redis \
    --link nodeodm.service \
    --name %n \
    --tmpfs /tmp \
    -v /opt/data/webodm:/webodm/app/media \
    -v /etc/webodm.py:/webodm/webodm/local_settings.py \
    -v /opt/webodm/app/models/task.py:/webodm/app/models/task.py \
    -v /opt/webodm/app/static/app/js/classes/AssetDownloads.js:/webodm/app/static/app/js/classes/AssetDownloads.js \
    -v /opt/webodm/app/static/app/js/components/Map.jsx:/webodm/app/static/app/js/components/Map.jsx \
    -v /opt/webodm/plugins/osm-quickedit/public/main.js:/webodm/plugins/osm-quickedit/public/main.js \
    opendronemap/webodm_webapp \
    bash -c \"webpack --mode production && python manage.py collectstatic --noinput && /webodm/start.sh\""

[Install]
WantedBy=multi-user.target
