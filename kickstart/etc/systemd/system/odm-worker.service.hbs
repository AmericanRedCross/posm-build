[Unit]
Description=OpenDroneMap API - worker
After=odm-web.service
Requires=docker.service redis.service odm-web.service

[Service]
Restart=always
KillSignal=SIGKILL
ExecStartPre=-/usr/bin/docker kill %n
ExecStartPre=-/usr/bin/docker rm %n
ExecStart=/bin/bash -c "docker run \
    --rm \
    --add-host $(jq -r .posm_fqdn /etc/posm.json):$(ifconfig $(jq -r .posm_wan_netif /etc/posm.json) | grep 'inet ' | awk '{print $2}') \
    --entrypoint celery \
    -e REDIS_URL=redis://redis \
    -e SERVER_NAME=$(jq -r .posm_fqdn /etc/posm.json) \
    --link redis \
    --name %n \
    --tmpfs /tmp \
    -u $(id -u posm-admin):$(id -g posm-admin) \
    -v /opt/data/opendronemap:/app/projects \
    -v /opt/data/uploads:/app/uploads \
    quay.io/mojodna/posm-opendronemap-api \
    worker -A app.celery --loglevel=info --concurrency=1"

[Install]
WantedBy=multi-user.target
